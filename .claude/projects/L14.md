# L14: Error Recovery Patterns

**Priority**: Medium
**Status**: done

## Overview
Patterns for recovering from errors in the lineage system.

## Problem
- Gemini calls can fail (rate limits, network)
- Qdrant storage can fail
- Subagents can timeout or crash

## Tasks
- [x] Document common failure modes
- [x] Define recovery patterns
- [x] Integrate with health monitor (L08)

## Results

### Common Failure Modes

| Component | Failure | Detection | Recovery |
|-----------|---------|-----------|----------|
| Gemini | Rate limit | <500 byte output | Wait, retry with different account |
| Gemini | Timeout | No response | Retry once, then skip |
| Qdrant | Connection | HTTP error | Check Docker, restart if needed |
| Qdrant | Storage | Non-ok status | Log, retry batch |
| Ollama | Embedding | Null embedding | Fall back to hash embedding |
| Subagent | Timeout | Task timeout | Kill and report partial |

### Recovery Patterns

**Pattern 1: Graceful Degradation**
```python
embedding = get_ollama_embedding(text)
if not embedding:
    embedding = get_hash_embedding(text)  # Fallback
```

**Pattern 2: Retry with Backoff**
```python
for attempt in range(3):
    result = call_gemini(account)
    if result:
        break
    time.sleep(5 * (attempt + 1))  # 5s, 10s, 15s
```

**Pattern 3: Circuit Breaker (L08)**
```python
monitor = GeminiHealthMonitor()
account = monitor.get_best_account()  # Avoids broken account
result = monitor.record_request(account, success)
# Circuit opens after 3 failures, heals after 60s
```

**Pattern 4: Output Validation**
```bash
SIZE=$(stat -c%s "$OUTPUT_FILE")
if [ "$SIZE" -lt 500 ]; then
    echo "Failed: small output"
    # Re-queue or skip
fi
```

### Already Implemented

- **L08**: Circuit breaker for Gemini accounts
- **Storage scripts**: Hash fallback for failed embeddings
- **Skills**: Output size validation in bash scripts

## Handoff
Complete. Error recovery patterns documented. Circuit breaker (L08) handles Gemini failures.

---
**Started**: 2026-01-16
**Completed**: 2026-01-16
**Owner**: @claude
