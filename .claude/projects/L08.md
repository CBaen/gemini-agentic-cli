# L08: Gemini Worker Health Monitoring

**Thesis**: `research/system_theses/SUMMARY.md` (L08 section)
**Priority**: Medium
**Status**: done

## Overview
Add health monitoring to Gemini workers: rate limit tracking, circuit breakers, account rotation.

## Tasks
- [x] Create Gemini health monitor module
- [x] Implement rate limit tracking
- [x] Implement circuit breaker pattern
- [x] Add account rotation logic
- [x] Test all components

## Results

**Created: `~/.claude/scripts/gemini-health-monitor.py`**

### Features

**Rate Limit Tracking:**
- Tracks RPM per account
- Warns at 50 RPM (83% of 60 limit)
- Auto-cleans old timestamps every minute

**Circuit Breaker:**
- CLOSED: Normal operation
- OPEN: After 3 consecutive failures, blocks requests for 60s
- HALF_OPEN: After timeout, allows test request

**Account Rotation:**
- `get_best_account()` returns healthiest account
- Scoring: 60% RPM headroom + 40% success rate
- Falls back to account 1 if all circuits open

**State Persistence:**
- Saves to `~/.claude/gemini-health-state.json`
- Survives script restarts

### CLI Usage
```bash
# Check status
python ~/.claude/scripts/gemini-health-monitor.py status

# Get best account (for scripting)
python ~/.claude/scripts/gemini-health-monitor.py best

# Reset tracking
python ~/.claude/scripts/gemini-health-monitor.py reset
python ~/.claude/scripts/gemini-health-monitor.py reset --account 1
```

### Python Integration
```python
from gemini_health_monitor import GeminiHealthMonitor

monitor = GeminiHealthMonitor()

# Get best account to use
account = monitor.get_best_account()

# Record request result
result = monitor.record_request(account, success=True)

# Check for warnings
if result["warnings"]:
    print(f"Warning: {result['warnings']}")
```

### Testing Results
```
Account 1 (5 successes): RPM=5, Circuit=closed, Success=100%
Account 2 (3 failures): RPM=3, Circuit=open, Success=0%
Best account: 1 (correct - avoids open circuit)
```

## Configuration
- `RPM_LIMIT = 60` - Gemini rate limit
- `RPM_WARN_THRESHOLD = 50` - Warn at 83%
- `CIRCUIT_BREAK_THRESHOLD = 3` - Failures before opening
- `CIRCUIT_OPEN_TIMEOUT = 60` - Seconds before half-open

## Handoff
Complete. Health monitor module ready for integration with existing Gemini scripts.

---
**Started**: 2026-01-16
**Completed**: 2026-01-16
**Owner**: @claude
