# L02: Gemini Prompt Engineering

**Thesis**: `research/system_theses/SUMMARY.md` (L02 section)
**Priority**: High
**Status**: done

## Overview
Fix inconsistent JSON output from Gemini. Key finding: Gemini 2.0 Flash does NOT have JSON mode.

## Tasks
- [x] Find current Gemini prompt patterns in codebase
- [x] Implement schema definition pattern
- [x] Add explicit JSON-only instruction
- [x] Include example output in prompts
- [x] Test JSON consistency (storage scripts already have robust cleaning)
- [x] Document patterns

## Results
**Created**: `~/.claude/scripts/gemini-json-helper.py`
- Standard prompt wrapper for JSON output
- Response cleaning function (handles markdown, credentials prefix)
- Research schema template with example

**Updated skills**:
- `lineage-research/SKILL.md` - Added explicit JSON requirements block
- `lineage-consult/SKILL.md` - Added explicit JSON requirements block

**The standard JSON instruction block**:
```
CRITICAL OUTPUT REQUIREMENTS:
- Return ONLY valid JSON
- Do NOT wrap in markdown code blocks (no triple backticks)
- Do NOT include any text before or after the JSON
- Do NOT include explanations, notes, or commentary
- The response must start with { and end with }
```

**Note**: `qdrant-store-gemini.py` already has robust `clean_gemini_output()` that handles:
- Credentials prefix stripping
- Markdown code block removal
- JSON extraction by brace matching

## Handoff
Complete. Key insight: Explicit multi-line instructions work better than single-line "Return ONLY JSON".

---
**Started**: 2026-01-16
**Completed**: 2026-01-16
**Owner**: @claude
